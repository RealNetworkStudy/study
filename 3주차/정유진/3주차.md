### 3주차 **송출한 패킷이 네트워크 기기를 경유하여 인터넷을 향해**

- 케이블이 송출한 패킷이 리피터, 허브, 스위치, 라우터 등의 네트워크 기기를 경유하여 인터넷을 향해 진행하는 과정

브라우저에서 만들었던 HTTP 메시지가 여러 계층을 거치며 헤더들을 더해나가 랜 카드를 거쳐 신호로 변환되었다.  
이제 이러한 신호가 어떻게 인터넷 공간까지 이동하게 될까?

### 개요

1. **케이블**을 통해 리피터 허브에 도착한다.
2. **리피터**가 신호를 증폭한다.
3. **허브**는 수신한 패킷을 모든 포트로 브로드캐스트한다.
4. **스위칭 허브**는 MAC 주소를 기반으로 정확한 포트로 패킷을 전달한다.
5. **라우터**는 IP 주소를 기반으로 다음 라우터를 찾아 패킷을 전달한다.
6. **ISP**는 인터넷 백본을 통해 패킷을 목적지 네트워크로 전달한다.
7. **목적지 서버**는 패킷을 수신하고 헤더를 제거한 후 데이터를 처리한다.

---

## 1. 케이블과 리피터, 허브 속으로 신호가 흘러간다.

### **1. 하나하나의 패킷이 독립된 것으로 동작한다.**

- 패킷은 개별적으로 처리되며, 순서가 바뀌거나 다른 경로로 갈 수도 있다.
- 패킷은 헤더에 기록된 정보와 중계 장치(허브, 라우터)의 내부의 테이블을 통해 목적지를 판단하고 패킷을 중계한다.
- 애플리케이션이 작성한 데이터나 TCP 헤더는 패킷 운반 동작에 영향을 주지 않는다.
- 중계 장치의 내부 테이블
    
    
    | 네트워크 장비 | 중계 대상 테이블 | 역할 |
    | --- | --- | --- |
    | 리피터 허브 | 없음 | 신호 증폭, 모든 포트로 패킷 전송 |
    | 스위칭 허브 | MAC 주소 테이블 | 목적지 MAC 주소를 보고 패킷 전송 |
    | 라우터 | 라우팅 테이블 | 목적지 IP 주소를 보고 경로 선택 |

### **2. LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다.**

- LAN 어댑터의 PHY(MAU) 회로에서 전기 신호로 형태를 바꾼 패킷은 RJ-45 커넥터를 통해 **트위스트 페어 케이블**에 들어간다.
- 이더넷 신호의 실체는 플러스와 마이너스의 전압이다.
    - 1 (HIGH) → 특정 전압(예: +5V)
    - 0 (LOW) → 특정 전압(예: 0V 또는 -5V)
- 케이블 속을 흘러 리피터 허브의 커넥터 부분에 도착하고, 이 부분은 단순히 전기 신호가 케이블을 통해 전달된다.
- 송출한 신호는 케이블을 통해 허브로 가면서 신호가 약해지고, 각이 뭉개지거나, 잡음으로 변형되기도 한다. → 통신 오류의 원인이 된다

### **3. '꼼'은 잡음을 방지하기 위한 방법이다.**

- LAN 케이블로 사용하는 트위스트 페어 케이블은 두 가닥의 신호선을 마주 꼬아서 잡음의 영향을 억제한다

### **4. 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다.**

- 리피터 허브에서 PHY(MAU)회로의 수신부에 도달한 신호는 리피터 회로에 들어간다.
- 리피터 회로의 기본은 들어오는 신호를 리피터 허브의 커넥터 부분에 뿌리는 데 있다.
- 신호는 모든 커넥터에서 나가면서 리피터 허브에 접속한 전체 기기에 도달한다.
- 패킷을 수신한 기기들은 MAC 헤더의 수신처 주소를 보고 자기와 일치하면 패킷을 받아들인다.

---

## 2. 스위칭 허브가 패킷을 중계한다.

### **1. 스위칭 허브는 주소 테이블로 중계한다.**

- 스위칭 허브는 이더넷 패킷을 그대로 목적지로 중계한다.
- 신호 → 커넥터(RJ-45 포트) → PHY(MAU) 회로 **→** 공통 신호 형식 → MAC 회로**→** 데이터 패킷
- 패킷의 FCS를 대조하여 오류가 있으면 패킷을 버리고, 문제가 없으면 버퍼 메모리에 저장한다.
- 수신처 MAC 주소를 MAC 주소 테이블과 비교하여 목적지 포트를 찾는다.
    - **등록된 MAC 주소가 있다면** → 해당 포트로만 패킷 전송.
    - **등록된 MAC 주소가 없다면** → 네트워크 전체(Broadcast)로 패킷을 보냄.
- **스위치 회로**를 통해 해당 포트로 패킷을 보낸다.

### **2. MAC 주소 테이블을 등록 및 갱신한다.**

- 스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용도 갱신한다.
    - 수신한 패킷에서 [송신처 MAC 주소, 입력 포트 번호]를 MAC 주소 테이블에 추가
    - 사용하지 않고 일정 시간 경과한 경우 오래된 정보를 MAC 주소표에서 삭제

### **3. 예외적인 동작**

- 송신 포트와 수신 포트가 같은 경우
    - 스위칭 허브에 리피터 허브가 접속된 경우
    - 패킷을 중계하지 않고 폐기
- MAC 주소 테이블에 수신처 MAC 주소가 없는 경우
    - 수신한 포트를 제외한 모든 포트로 패킷을 전송
- 수신처 MAC 주소가 브로드캐스트 주소인 경우
    - 수신한 포트를 제외한 모든 포트로 패킷을 전송

### **4. 전이중 모드에서 송신과 수신을 동시에 실행한다.**

- 스위칭 허브 - 전이중 모드: 송신과 수신을 동시에 실행할 수 있다
- 리피터 허브 - 반이중 모드:  다른 신호가 흐르면 기다렸다가 실행해야 한다.

### **5. 스위칭 허브는 복수의 중계 동작을 동시에 실행한다.**

- 스위칭 허브는 복수의 패킷을 동시에 중계할 수 있다.
- 스위칭 허브는 수신처 MAC 주소의 기기가 존재하는 포트 이외에는 송신 동작을 실행하지 않으므로 다른 포트는 빈 상태가 된다. 비어 있는 포트에서 다른 패킷을 흘릴 수 있다.
- 리피터 허브는 들어온 신호를 모든 포트에서 뿌리므로 복수의 신호를 동시에 흘릴 수 없다.

---

## 3. 라우터가 패킷을 중계한다.

### **1. 라우터의 기본**

- 리피터 허브나 스위칭 허브를 경유한 패킷은 결국 라우터에 도착하고, 라우터에서 다음 라우터로 중계된다.
- 중계 부분
    - 패킷의 중계 대상을 판단하는 동작 담당
    - **라우팅 테이블**에 저장된 정보를 바탕으로, **패킷의 목적지 IP 주소**를 확인하고 **다음 목적지 라우터**나 **최종 목적지**로 패킷을 전달하는 경로를 결정한다.
- 포트 부분
    - 패킷을 송, 수신하는 동작 담당
    - 라우터의 각 포트에는 MAC 주소와 IP가 할당되어 있다.

### **2. 경로표에 등록된 정보**

- 스위칭 허브는 MAC 헤더에 기록된 수신처 MAC 주소로 중계 대상을 판단하고, 라우터는 IP 헤더에 기재되어 있는 수신처 IP 주소로 중계 대상을 판단한다.
- **라우팅 테이블의 주요 항목**
    
    
    | 항목 | 설명 |
    | --- | --- |
    | **수신처** | 목적지 네트워크 주소 (네트워크 번호만 포함) |
    | **서브넷 마스크** | 네트워크 주소와 호스트 주소를 구분하는 비트 수 |
    | **게이트웨이** | 다음 라우터의 IP 주소 (목적지가 직접 연결된 네트워크가 아닐 경우) |
    | **인터페이스** | 패킷을 내보낼 라우터의 포트 |
    | **메트릭** | 해당 경로의 비용(거리) - 낮을수록 좋은 경로 |
- **라우팅 테이블의 동작 방식**
    - 패킷의 IP 헤더에서 수신처 IP 주소를 확인한다.
    - 라우팅 테이블의 수신처(Destination)와 패킷의 목적지 IP 주소를 비교한다.
        - 네트워크 번호만 비교하며, 호스트 번호는 무시한다.
    - 서브넷마스크를 사용하여 IP 주소의 네트워크 번호 부분만 추출한 후, 라우팅 테이블의 네트워크 번호와 일치하는지 판단한다.
    - 여러 개의 경로가 일치할 경우, 메트릭 값이 가장 낮은 경로를 선택한다.
    - 라우팅 테이블에서 찾은 인터페이스(포트)를 통해 패킷을 전송한다.
    - 게이트웨이 주소가 설정되어 있으면 해당 게이트웨이(다음 라우터)로 패킷을 전달한다.
    - 해당하는 항목이 발견되지 않는다면, 패킷을 폐기하고 ****ICMP 메시지로 송신처에 이 사실을 통지
- **주소 집약**
    - 여러 개의 서브넷을 하나의 경로로 묶어 라우팅 테이블을 단순화하는 기법
    - `192.168.1.0/24`**,** `192.168.2.0/24` 두 개의 네트워크를 `192.168.0.0/22`로 묶어 한 줄로 관리할 수 있다.
- **라우팅 테이블 구성 방식**
    - 정적 라우팅
        - 사람이 직접 **경로 정보를 수동으로 등록**
    - 동적 라우팅
        - 라우팅 프로토콜(RIP, OSPF, BGP 등)을 이용해 라우터들이 자동으로 경로 정보를 교환

### **3. 라우터의 패킷 수신 동작**

- 라우터 각각의 포트(인터페이스)에는 고유한 MAC 주소가 할당되어 있다.
- 라우터는 이더넷 프레임의 수신처 MAC 주소를 확인한 후, 자신의 MAC 주소와 일치하는 패킷만 수신하고, 일치하지 않는 패킷은 폐기한다.
- 수신한 패킷의 IP 헤더를 분석하여 다음 목적지를 결정하고, 다음 목적지의 MAC 주소를 새롭게 설정해서 패킷을 보낸다.
- IP 주소는 유지되지만, MAC 주소는 변경됨

### **4. 경로표를 검색하여 출력 포트를 발견한다.**

- 라우팅 예시
    
    
    | 수신처(Destination) | 서브넷마스크 | 게이트웨이 | 인터페이스 | 메트릭 |
    | --- | --- | --- | --- | --- |
    | `192.168.1.0` | `255.255.255.0` | `-` (직접 연결) | `eth0` (LAN 포트) | `1` |
    | `192.168.2.0` | `255.255.255.0` | `192.168.1.254` | `eth0` (LAN 포트) | `2` |
    | `10.0.0.0` | `255.0.0.0` | `203.0.113.1` | `eth1` (WAN 포트) | `5` |
    | `0.0.0.0` (기본 경로) | `0.0.0.0` | `192.168.1.1` | `eth0` (LAN 포트) | `10` |
    - 직접 연결된 네트워크(`192.168.1.10`): ****게이트웨이를 거치지 않고 바로 전송
    - 다른 서브넷 (`192.168.2.0/24`):  `192.168.1.254` 게이트웨이 로 패킷 전송
    - 외부 네트워크 (`10.0.0.0/8`) : WAN 포트(`eth1`)를 통해 게이트웨이 `203.0.113.1`을 거쳐 전송
    - 기본경로: 라우팅 테이블에 없는 목적지로 가는 모든 패킷. 인터넷으로 나가는 트래픽은 `192.168.1.1`(기본 게이트웨이)로 전송된다.
- 다른 서브넷과 외부 네트워크 ?
    - 같은 조직(네트워크) 내에 존재하지만, 서브넷이 다른 네트워크. 라우터를 통해 중계 가능
    - 조직(내부 네트워크) 외부에 있는 네트워크(인터넷 등). 보통 기본 게이트웨이를 통해 중계
    - 인터넷으로 가려면 ISP(인터넷 제공 업체) 라우터를 통해 연결됨.

### **6. 패킷은 유효 기간이 있다.**

- IP 패킷은 **TTL(Time to Live)**라는 필드를 이용해 유효 기간을 설정한다.
- 송신 측에서 TTL 값을 설정 (일반적으로 64 또는 128)
- 각 라우터를 경유할 때마다 TTL 값을 1씩 감소시킨다.
- TTL = 0이 되면 패킷을 폐기하고, 송신자에게 ICMP "Time Exceeded" 메시지를 전송
- 인터넷을 통해 지구 반대편까지 가도 라우터를 수십 개 정도만 거치므로, TTL 64~128이면 충분하다

### **7. 큰 패킷은 조각 나누기 기능으로 분할한다.**

- 네트워크마다 허용하는 최대 패킷 크기(MTU)가 다르다.
- MTU보다 큰 패킷을 작은 조각으로 나눠 전송
- ① 패킷 크기 확인 → ② MTU에 맞게 데이터 조각화 → ③ IP 헤더 추가 후 전송
- 재조립: 수신 측에서 Identification & Fragment Offset을 이용해 원래 데이터로 복구
    - 조각 중 일부가 손실되면 전체 패킷을 폐기하고, 재전송을 요청해야 함
- DF(Don't Fragment) 비트가 설정된 패킷은 조각화 불가, MTU보다 크면 폐기

### **9. 라우터와 스위칭 허브의 관계**

- **라우터** (IP 주소 기반)
    - 목적지 IP 주소를 기준으로 라우팅 테이블을 검색하여 다음 목적지를 찾음
    - TTL 값을 감소시켜 무한 루프 방지
    - 필요하면 조각 나누기 수행
- **스위칭 허브** (MAC 주소 기반)
    - MAC 주소를 기반으로 해당 네트워크(서브넷) 내에서 패킷을 전달
    - 같은 네트워크 안에서 올바른 포트로 패킷을 보내는 역할
    - 목적지 MAC 주소가 없으면 브로드캐스트(모든 포트로 전송)
 
---

[성공과 실패를 결정하는 1%의 네트워크 원리 3장](https://devdebin.tistory.com/263)
